# MainActivity 重构状态报告

## 当前情况
- MainActivity 接近 2000 行，职责过多
- 已尝试拆分 MessageSender 类，但遇到以下问题：
  1. 回调接口设计复杂
  2. 大量的 suspend 函数和协程上下文切换
  3. UI 回调与业务逻辑耦合紧密

## 问题分析

### 1. MessageSender 拆分的挑战
- sendMessage() 方法约 700 行，包含：
  - Agent 模式执行（简单循环、图策略）
  - 普通聊天模式
  - 流式输出处理
  - 错误处理和恢复
  - UI 更新回调
- 这些逻辑高度耦合，难以简单地通过回调接口分离

### 2. 当前架构的限制
- MainActivity 直接操作 UI 组件
- 业务逻辑与 UI 更新混在一起
- 没有明确的数据流和状态管理

## 建议的重构方案（修订版）

### 方案 A：保持现状，局部优化（推荐）
**优点**：
- 风险最小
- 不影响现有功能
- 可以逐步改进

**实施步骤**：
1. 添加代码注释和区域标记，提高可读性
2. 将辅助方法提取到 companion object 或 extension functions
3. 使用 `// region` 和 `// endregion` 标记功能区域

**预期效果**：
- 代码行数不变，但可读性提高
- 维护成本降低
- 为未来重构打下基础

### 方案 B：引入 ViewModel（中期目标）
**优点**：
- 符合 Android 架构最佳实践
- 业务逻辑与 UI 分离
- 支持配置变更（如屏幕旋转）

**实施步骤**：
1. 创建 `ChatViewModel` 管理对话状态
2. 创建 `MessageSendViewModel` 管理消息发送逻辑
3. 使用 LiveData/StateFlow 通知 UI 更新
4. MainActivity 只负责 UI 渲染和用户交互

**预期效果**：
- MainActivity 减少到 800-1000 行
- 业务逻辑可测试
- 代码结构更清晰

### 方案 C：完全重构为 MVVM + Repository（长期目标）
**优点**：
- 最佳的架构设计
- 高度可测试
- 易于维护和扩展

**实施步骤**：
1. 引入 Repository 层管理数据
2. 使用 ViewModel 管理 UI 状态
3. 使用 DataBinding 或 ViewBinding
4. 引入依赖注入（Hilt/Koin）

**预期效果**：
- MainActivity 减少到 400-600 行
- 完全符合 Android 架构指南
- 但需要大量重构工作

## 当前建议

鉴于项目的复杂性和时间成本，我建议：

1. **立即执行**：方案 A（局部优化）
   - 添加代码区域标记
   - 提取辅助方法
   - 改善代码可读性

2. **中期规划**：方案 B（引入 ViewModel）
   - 逐步迁移到 MVVM 架构
   - 先从简单的功能开始（如对话列表）
   - 逐步扩展到消息发送

3. **长期目标**：方案 C（完全重构）
   - 在新功能开发时采用新架构
   - 旧代码逐步迁移
   - 保持向后兼容

## 下一步行动

你希望我执行哪个方案？

- [ ] 方案 A：立即优化代码结构（添加注释和区域标记）
- [ ] 方案 B：开始引入 ViewModel
- [ ] 方案 C：制定完整重构计划
- [ ] 其他建议

请告诉我你的选择，我会立即开始执行。
